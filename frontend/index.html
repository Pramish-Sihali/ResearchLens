<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchLens - AI Research Analysis</title>

    <meta name="description" content="Analyze academic papers and discover research opportunities">

    <!-- Google Fonts - Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        cream: '#F0EEE6',
                        dark: '#141413',
                        accent: '#121121',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F0EEE6;
            min-height: 100vh;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #F0EEE6;
            border-top: 3px solid #121121;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #e8e6de 25%, #dddbd3 50%, #e8e6de 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Abstract accordion */
        .abstract-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .abstract-content.expanded {
            max-height: 500px;
        }

        /* Proposal accordion */
        .proposal-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .proposal-content.expanded {
            max-height: 10000px;
        }

        /* Academic Paper Styling - LaTeX-like formatting */
        .academic-paper {
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 2;
            color: #000;
            background: white;
            padding: 1in;
            margin: 0 auto;
            max-width: 8.5in;
        }

        .academic-paper .title-page {
            text-align: center;
            padding: 2in 0;
            page-break-after: always;
        }

        .academic-paper .title-page h1 {
            font-size: 18pt;
            font-weight: bold;
            margin-bottom: 2rem;
            text-transform: uppercase;
        }

        .academic-paper .title-page .author {
            font-size: 12pt;
            margin: 0.5rem 0;
        }

        .academic-paper .title-page .affiliation {
            font-size: 11pt;
            font-style: italic;
            margin: 0.5rem 0;
        }

        .academic-paper .title-page .date {
            font-size: 12pt;
            margin-top: 2rem;
        }

        .academic-paper .abstract-section {
            margin: 2rem 0;
        }

        .academic-paper .abstract-section h2 {
            font-size: 14pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1rem;
        }

        .academic-paper .abstract-section p {
            text-align: justify;
            text-indent: 0;
            font-size: 11pt;
            line-height: 1.5;
        }

        .academic-paper .abstract-section .keywords {
            margin-top: 1rem;
            font-size: 11pt;
        }

        .academic-paper .abstract-section .keywords strong {
            font-style: italic;
        }

        .academic-paper h2 {
            font-size: 14pt;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .academic-paper h3 {
            font-size: 12pt;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .academic-paper p {
            text-align: justify;
            text-indent: 0.5in;
            margin-bottom: 0;
        }

        .academic-paper p.no-indent {
            text-indent: 0;
        }

        .academic-paper ul, .academic-paper ol {
            margin-left: 0.5in;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .academic-paper li {
            margin-bottom: 0.25rem;
        }

        .academic-paper .section-number {
            font-weight: bold;
        }

        .academic-paper .references-section {
            margin-top: 2rem;
        }

        .academic-paper .references-section h2 {
            text-align: center;
        }

        .academic-paper .reference-item {
            text-indent: -0.5in;
            padding-left: 0.5in;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .academic-paper .page-number {
            text-align: center;
            font-size: 10pt;
            margin-top: 1rem;
            color: #666;
        }

        .academic-paper table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 11pt;
        }

        .academic-paper table th,
        .academic-paper table td {
            border: 1px solid #000;
            padding: 0.5rem;
            text-align: left;
        }

        .academic-paper table th {
            font-weight: bold;
            background: #f5f5f5;
        }

        /* Page break styles for printing/PDF */
        @media print {
            .academic-paper {
                padding: 0;
            }

            /* Page numbering */
            @page {
                margin: 1in;
                @bottom-center {
                    content: "— " counter(page) " —";
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 10pt;
                }
            }

            /* Title page - no page number */
            .academic-paper .title-page {
                page: title-page;
            }

            @page title-page {
                @bottom-center {
                    content: none;
                }
            }

            /* Mandatory page breaks */
            .academic-paper .title-page {
                page-break-after: always;
            }

            .academic-paper .abstract-section {
                page-break-after: always;
            }

            .academic-paper .references-section {
                page-break-before: always;
            }

            /* Recommended page breaks - after major sections */
            .academic-paper .section-literature-review {
                page-break-after: always;
            }

            /* Keep tables together */
            .academic-paper table {
                page-break-inside: avoid;
            }

            /* Keep headings with content */
            .academic-paper h2,
            .academic-paper h3 {
                page-break-after: avoid;
            }

            /* Avoid orphans and widows */
            .academic-paper p {
                orphans: 3;
                widows: 3;
            }

            /* Hide screen-only page number */
            .academic-paper .page-number {
                display: none;
            }
        }

        /* Page break indicators for screen (visual only) */
        .page-break-indicator {
            border-top: 2px dashed #ccc;
            margin: 2rem 0;
            position: relative;
        }

        .page-break-indicator::after {
            content: 'Page Break';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            font-size: 9pt;
            color: #999;
        }

        /* References section */
        .references-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .references-content.expanded {
            max-height: 2000px;
        }

        .references-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Custom scrollbar */
        .references-list::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .references-list::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: #F0EEE6;
        }

        .references-list::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb {
            background: #141413;
            border-radius: 2px;
        }

        /* Tab styles */
        .tab-btn {
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background-color: #141413;
            color: #F0EEE6;
        }

        .tab-content {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Checkbox styles */
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #141413;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-checkbox:checked {
            background-color: #121121;
            border-color: #121121;
        }

        .custom-checkbox:checked::after {
            content: '✓';
            display: block;
            text-align: center;
            color: #F0EEE6;
            font-size: 12px;
            line-height: 14px;
        }

        /* Button styles */
        .btn-primary {
            background-color: #141413;
            color: #F0EEE6;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #121121;
        }

        .btn-primary:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #121121;
            color: #F0EEE6;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #141413;
        }

        /* Card styles */
        .card {
            background-color: white;
            border: 1px solid #e5e3db;
        }

        /* Input styles */
        .input-field {
            border: 2px solid #141413;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(18, 17, 33, 0.1);
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-accent py-4">
        <div class="container mx-auto px-4 max-w-6xl">
            <h1 class="text-2xl font-extrabold text-white text-start">ResearchLens</h1>
            <p class="text-white/60 text-sm font-medium text-start">AI-Powered Research Analysis & Discovery</p>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-6xl" style="padding-top: 100px;">

        <!-- Search Form -->
        <div class="card rounded-xl p-6 mb-6">
            <form id="searchForm" class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="topicInput"
                        placeholder="Enter research topic (e.g., machine learning in healthcare)"
                        class="w-full px-4 py-3 rounded-lg input-field text-dark placeholder-dark/40"
                        required
                        minlength="3"
                        maxlength="200"
                    >
                </div>
                <button
                    type="submit"
                    id="submitBtn"
                    class="px-6 py-3 btn-primary rounded-lg font-semibold flex items-center justify-center gap-2"
                >
                    <span id="btnText">Analyze</span>
                    <div id="btnSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="card rounded-xl p-6 mb-6">
                <div class="flex flex-col items-center py-6">
                    <div class="loading-spinner mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
                    <p class="text-dark font-semibold mb-1">Analyzing Research Papers</p>
                    <p class="text-sm text-dark/50">This may take 30-40 seconds</p>
                </div>
                <div class="space-y-3 mt-4 pt-4 border-t border-dark/10">
                    <div class="skeleton h-3 rounded w-3/4"></div>
                    <div class="skeleton h-3 rounded w-1/2"></div>
                    <div class="skeleton h-3 rounded w-5/6"></div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden card rounded-xl p-4 mb-6 border-red-300 bg-red-50">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="text-red-800 font-semibold text-sm">Analysis Failed</h3>
                    <p id="errorMessage" class="text-red-600 text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Top Row: Stats and Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- Summary Stats -->
                <div class="card rounded-xl p-5 fade-in">
                    <h2 class="text-sm font-bold text-dark mb-4 uppercase tracking-wide">Summary</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center p-3 bg-cream rounded-lg">
                            <p class="text-2xl font-bold text-dark" id="totalPapers">0</p>
                            <p class="text-xs text-dark/50 font-medium">Papers</p>
                        </div>
                        <div class="text-center p-3 bg-cream rounded-lg">
                            <p class="text-2xl font-bold text-dark" id="avgCitations">0</p>
                            <p class="text-xs text-dark/50 font-medium">Avg Citations</p>
                        </div>
                        <div class="text-center p-3 bg-cream rounded-lg">
                            <p class="text-2xl font-bold" id="trendDirection">-</p>
                            <p class="text-xs text-dark/50 font-medium">Trend</p>
                        </div>
                        <div class="text-center p-3 bg-cream rounded-lg">
                            <p class="text-2xl font-bold" id="growthPercent">0%</p>
                            <p class="text-xs text-dark/50 font-medium">Growth</p>
                        </div>
                    </div>
                    <p id="cacheIndicator" class="text-xs text-dark/40 mt-3 hidden">From cache</p>
                </div>

                <!-- Trend Chart -->
                <div class="card rounded-xl p-5 fade-in">
                    <h2 class="text-sm font-bold text-dark mb-4 uppercase tracking-wide">Citation Trends</h2>
                    <div class="h-40">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabbed Content: Gaps, Questions, Methodologies -->
            <div class="card rounded-xl p-5 mb-4 fade-in">
                <!-- Tabs -->
                <div class="flex gap-2 mb-4 border-b border-dark/10 pb-3">
                    <button class="tab-btn active px-4 py-2 rounded-lg text-sm font-semibold" data-tab="gaps">
                        Research Gaps
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold text-dark/60 hover:text-dark" data-tab="questions">
                        Questions
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold text-dark/60 hover:text-dark" data-tab="methods">
                        Methodologies
                    </button>
                    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold text-dark/60 hover:text-dark" data-tab="refs">
                        References
                    </button>
                </div>

                <!-- Tab Contents -->
                <div id="gapsTab" class="tab-panel">
                    <ul id="researchGaps" class="space-y-2 tab-content"></ul>
                </div>

                <div id="questionsTab" class="tab-panel hidden">
                    <ul id="researchQuestions" class="space-y-2 tab-content"></ul>
                </div>

                <div id="methodsTab" class="tab-panel hidden">
                    <ul id="methodologySuggestions" class="space-y-2 tab-content"></ul>
                </div>

                <div id="refsTab" class="tab-panel hidden">
                    <div id="referencesList" class="space-y-3 tab-content text-sm"></div>
                </div>
            </div>

            <!-- Proposal Generation Section -->
            <div class="card rounded-xl p-5 mb-4 fade-in">
                <h2 class="text-sm font-bold text-dark mb-4 uppercase tracking-wide">Generate Proposal</h2>
                <p class="text-sm text-dark/60 mb-4">Select items to include in your research proposal:</p>

                <!-- Selection Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <!-- Selected Gaps -->
                    <div>
                        <h3 class="text-xs font-bold text-dark mb-2 uppercase">Research Gaps</h3>
                        <div id="gapSelections" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>

                    <!-- Selected Questions -->
                    <div>
                        <h3 class="text-xs font-bold text-dark mb-2 uppercase">Questions</h3>
                        <div id="questionSelections" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>

                    <!-- Selected Methods -->
                    <div>
                        <h3 class="text-xs font-bold text-dark mb-2 uppercase">Methodologies</h3>
                        <div id="methodSelections" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button
                    id="generateProposalBtn"
                    class="w-full px-6 py-3 btn-secondary rounded-lg font-semibold flex items-center justify-center gap-2"
                >
                    <span id="proposalBtnText">Generate Research Proposal</span>
                    <div id="proposalBtnSpinner" class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- Research Proposal (Expandable) -->
            <div id="proposalSection" class="card rounded-xl p-0 hidden fade-in overflow-hidden">
                <button id="proposalToggle" class="w-full flex justify-between items-start p-5 bg-dark text-cream">
                    <div>
                        <h2 class="text-sm font-bold uppercase tracking-wide">Research Proposal</h2>
                        <p class="text-xs text-cream/60 font-normal mt-1">For reference and templating only. Budget, timeline, and other details are sample assumptions.</p>
                    </div>
                    <svg id="proposalArrow" class="w-5 h-5 transform transition-transform rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="proposalContent" class="proposal-content expanded">
                    <div class="academic-paper">
                        <!-- Title Page -->
                        <div class="title-page">
                            <h1 id="proposalTitle">Research Proposal Title</h1>
                            <p class="author">Jane Doe</p>
                            <p class="affiliation">Department of Computer Science<br>University of Technology</p>
                            <p class="date" id="proposalDate"></p>
                        </div>

                        <!-- Abstract -->
                        <div class="abstract-section">
                            <h2>Abstract</h2>
                            <p id="proposalAbstract"></p>
                            <p class="keywords"><strong>Keywords:</strong> <span id="proposalKeywords"></span></p>
                        </div>

                        <!-- 1. Introduction -->
                        <h2><span class="section-number">1.</span> Introduction</h2>
                        <h3>1.1 Background and Context</h3>
                        <p id="proposalBackground"></p>
                        <h3>1.2 Problem Statement</h3>
                        <p id="proposalProblem"></p>
                        <h3>1.3 Significance of the Study</h3>
                        <p id="proposalSignificance"></p>
                        <h3>1.4 Research Gap</h3>
                        <p id="proposalGap"></p>

                        <!-- 2. Literature Review -->
                        <div class="section-literature-review">
                            <h2><span class="section-number">2.</span> Literature Review</h2>
                            <h3>2.1 Summary of Existing Research</h3>
                            <p id="proposalLitSummary"></p>
                            <h3>2.2 Gaps in Current Knowledge</h3>
                            <p id="proposalLitGaps"></p>
                            <h3>2.3 Theoretical Framework</h3>
                            <p id="proposalTheoretical"></p>
                        </div>

                        <!-- 3. Research Questions/Objectives -->
                        <h2><span class="section-number">3.</span> Research Questions and Objectives</h2>
                        <h3>3.1 Research Questions</h3>
                        <ol id="proposalQuestions"></ol>
                        <h3>3.2 Research Objectives</h3>
                        <ol id="proposalObjectives"></ol>

                        <!-- 4. Methodology -->
                        <h2><span class="section-number">4.</span> Methodology</h2>
                        <h3>4.1 Research Design</h3>
                        <p id="proposalDesign"></p>
                        <h3>4.2 Data Collection Methods</h3>
                        <p id="proposalDataCollection"></p>
                        <h3>4.3 Sample Size and Selection</h3>
                        <p id="proposalSample"></p>
                        <h3>4.4 Data Analysis Techniques</h3>
                        <p id="proposalAnalysis"></p>
                        <h3>4.5 Tools and Technologies</h3>
                        <p id="proposalTools"></p>

                        <!-- 5. Expected Outcomes -->
                        <h2><span class="section-number">5.</span> Expected Outcomes and Contributions</h2>
                        <h3>5.1 Anticipated Results</h3>
                        <p id="proposalResults"></p>
                        <h3>5.2 Contribution to the Field</h3>
                        <p id="proposalContribution"></p>
                        <h3>5.3 Potential Applications</h3>
                        <p id="proposalApplications"></p>

                        <!-- 6. Timeline -->
                        <h2><span class="section-number">6.</span> Timeline and Schedule</h2>
                        <table id="proposalTimeline">
                            <thead>
                                <tr>
                                    <th>Phase</th>
                                    <th>Activities</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="proposalTimelineBody">
                            </tbody>
                        </table>

                        <!-- 7. Budget -->
                        <h2><span class="section-number">7.</span> Budget</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Description</th>
                                    <th>Estimated Cost</th>
                                </tr>
                            </thead>
                            <tbody id="proposalBudgetBody">
                            </tbody>
                        </table>
                        <p class="no-indent" style="margin-top: 0.5rem;"><strong>Total Estimated Budget:</strong> <span id="proposalTotalBudget">$0</span></p>

                        <!-- 8. References -->
                        <div class="references-section">
                            <h2><span class="section-number">8.</span> References</h2>
                            <div id="proposalReferences"></div>
                        </div>

                        <p class="page-number">— 1 —</p>
                    </div>

                    <!-- Download Options -->
                    <div class="p-6 border-t border-dark/10 bg-cream/50" style="font-family: 'Nunito', sans-serif;">
                        <p class="text-xs text-dark/60 mb-3 text-center">Download this proposal for your records</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="downloadAsPDF()" class="px-4 py-2 bg-dark text-cream rounded-lg text-sm font-semibold flex items-center gap-2 hover:bg-accent transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download PDF
                            </button>
                            <!-- <button onclick="downloadAsDOCX()" class="px-4 py-2 bg-dark text-cream rounded-lg text-sm font-semibold flex items-center gap-2 hover:bg-accent transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download DOCX
                            </button> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://researchlens.onrender.com';

        // Store current analysis data
        let currentAnalysisData = null;

        // DOM Elements
        const searchForm = document.getElementById('searchForm');
        const topicInput = document.getElementById('topicInput');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const proposalToggle = document.getElementById('proposalToggle');
        const proposalContent = document.getElementById('proposalContent');
        const proposalArrow = document.getElementById('proposalArrow');
        const proposalSection = document.getElementById('proposalSection');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const proposalBtnText = document.getElementById('proposalBtnText');
        const proposalBtnSpinner = document.getElementById('proposalBtnSpinner');

        // Chart instance
        let trendChart = null;

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update button states
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('text-dark/60');
                });
                btn.classList.add('active');
                btn.classList.remove('text-dark/60');

                // Show corresponding panel
                const tabName = btn.dataset.tab;
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.add('hidden');
                });
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            });
        });

        // Proposal toggle
        proposalToggle.addEventListener('click', () => {
            proposalContent.classList.toggle('expanded');
            proposalArrow.classList.toggle('rotate-180');
        });

        // Generate Proposal button handler
        generateProposalBtn.addEventListener('click', async () => {
            if (!currentAnalysisData) return;

            // Get selected items
            const selectedGaps = getSelectedItems('gapSelections');
            const selectedQuestions = getSelectedItems('questionSelections');
            const selectedMethods = getSelectedItems('methodSelections');

            if (selectedGaps.length === 0 && selectedQuestions.length === 0 && selectedMethods.length === 0) {
                alert('Please select at least one item for the proposal.');
                return;
            }

            // Set loading state
            generateProposalBtn.disabled = true;
            proposalBtnText.textContent = 'Generating...';
            proposalBtnSpinner.classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}/generate-proposal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: currentAnalysisData.topic,
                        research_gaps: selectedGaps,
                        research_questions: selectedQuestions,
                        methodology_suggestions: selectedMethods
                    }),
                });

                const data = await response.json();

                if (data.proposal) {
                    renderProposal(data.proposal);
                    proposalSection.classList.remove('hidden');
                    proposalSection.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error('Proposal generation failed:', error);
                alert('Failed to generate proposal. Please try again.');
            } finally {
                generateProposalBtn.disabled = false;
                proposalBtnText.textContent = 'Generate Research Proposal';
                proposalBtnSpinner.classList.add('hidden');
            }
        });

        // Get selected items from a selection container
        function getSelectedItems(containerId) {
            const container = document.getElementById(containerId);
            const items = [];
            container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                items.push(cb.dataset.value);
            });
            return items;
        }

        // Form submission handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const topic = topicInput.value.trim();
            if (!topic) return;

            // Reset state
            currentAnalysisData = null;
            proposalSection.classList.add('hidden');

            // Show loading state
            setLoading(true);
            hideError();
            hideResults();

            try {
                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze topic');
                }

                currentAnalysisData = data;
                displayResults(data);

            } catch (error) {
                showError(error.message);
            } finally {
                setLoading(false);
            }
        });

        // Set loading state
        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            btnText.textContent = isLoading ? 'Analyzing...' : 'Analyze';
            btnSpinner.classList.toggle('hidden', !isLoading);
            loadingState.classList.toggle('hidden', !isLoading);
        }

        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorState.classList.remove('hidden');
        }

        // Hide error
        function hideError() {
            errorState.classList.add('hidden');
        }

        // Hide results
        function hideResults() {
            resultsSection.classList.add('hidden');
        }

        // Display results
        function displayResults(data) {
            // Summary stats
            document.getElementById('totalPapers').textContent = data.paper_summary.total_papers;
            document.getElementById('avgCitations').textContent = data.paper_summary.avg_citations;

            // Trend direction with color
            const trendDir = document.getElementById('trendDirection');
            const trend = data.trend_analysis.trend_direction;
            trendDir.textContent = formatTrend(trend);
            trendDir.className = `text-2xl font-bold ${getTrendColor(trend)}`;

            // Growth percentage
            const growth = data.trend_analysis.growth_percentage;
            const growthEl = document.getElementById('growthPercent');
            growthEl.textContent = `${growth > 0 ? '+' : ''}${growth}%`;
            growthEl.className = `text-2xl font-bold ${growth >= 0 ? 'text-green-600' : 'text-red-600'}`;

            // Cache indicator
            const cacheIndicator = document.getElementById('cacheIndicator');
            cacheIndicator.classList.toggle('hidden', !data.from_cache);

            // Render trend chart
            renderChart(data.trend_analysis.chart_data);

            // Research gaps
            const gapsList = document.getElementById('researchGaps');
            gapsList.innerHTML = data.research_gaps.map((gap, i) =>
                `<li class="p-3 bg-cream rounded-lg text-sm text-dark">${escapeHtml(gap)}</li>`
            ).join('');

            // Research questions
            const questionsList = document.getElementById('researchQuestions');
            questionsList.innerHTML = data.research_questions.map((question, i) =>
                `<li class="p-3 bg-cream rounded-lg text-sm text-dark">
                    <span class="font-semibold">${i + 1}.</span> ${escapeHtml(question)}
                </li>`
            ).join('');

            // Methodology suggestions
            const methodsList = document.getElementById('methodologySuggestions');
            methodsList.innerHTML = data.methodology_suggestions.map(method =>
                `<li class="p-3 bg-cream rounded-lg text-sm text-dark">${escapeHtml(method)}</li>`
            ).join('');

            // Render references
            renderReferences(data.references);

            // Render selection checkboxes
            renderSelections(data);

            // Show results
            resultsSection.classList.remove('hidden');

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Render selection checkboxes for proposal
        function renderSelections(data) {
            // Gap selections
            const gapSelections = document.getElementById('gapSelections');
            gapSelections.innerHTML = data.research_gaps.map((gap, i) =>
                `<label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" class="custom-checkbox mt-0.5" data-value="${escapeHtml(gap)}" checked>
                    <span class="text-xs text-dark/80 line-clamp-2">${escapeHtml(gap.substring(0, 60))}${gap.length > 60 ? '...' : ''}</span>
                </label>`
            ).join('');

            // Question selections
            const questionSelections = document.getElementById('questionSelections');
            questionSelections.innerHTML = data.research_questions.map((q, i) =>
                `<label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" class="custom-checkbox mt-0.5" data-value="${escapeHtml(q)}" checked>
                    <span class="text-xs text-dark/80 line-clamp-2">${escapeHtml(q.substring(0, 60))}${q.length > 60 ? '...' : ''}</span>
                </label>`
            ).join('');

            // Method selections
            const methodSelections = document.getElementById('methodSelections');
            methodSelections.innerHTML = data.methodology_suggestions.map((m, i) =>
                `<label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" class="custom-checkbox mt-0.5" data-value="${escapeHtml(m)}" checked>
                    <span class="text-xs text-dark/80 line-clamp-2">${escapeHtml(m.substring(0, 60))}${m.length > 60 ? '...' : ''}</span>
                </label>`
            ).join('');
        }

        // Render references
        function renderReferences(references) {
            const refList = document.getElementById('referencesList');
            refList.innerHTML = references.map((ref, index) =>
                `<div class="pb-3 border-b border-dark/10 last:border-0">
                    <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-cream bg-dark rounded-full">${ref.number}</span>
                    <p class="text-dark/80 mt-1 text-xs leading-relaxed">
                        ${ref.url
                            ? `<a href="${escapeHtml(ref.url)}" target="_blank" rel="noopener noreferrer" class="hover:text-accent hover:underline">${escapeHtml(ref.reference)}</a>`
                            : escapeHtml(ref.reference)
                        }
                    </p>
                    <button
                        onclick="toggleAbstract(${index})"
                        class="text-xs text-accent hover:underline mt-1 focus:outline-none font-medium"
                        id="abstractBtn${index}"
                    >
                        View Abstract
                    </button>
                    <div id="abstract${index}" class="abstract-content mt-2 text-xs text-dark/60 bg-cream p-2 rounded">
                        ${escapeHtml(ref.abstract)}
                    </div>
                </div>`
            ).join('');
        }

        // Toggle abstract visibility
        function toggleAbstract(index) {
            const abstractEl = document.getElementById(`abstract${index}`);
            const btnEl = document.getElementById(`abstractBtn${index}`);

            if (abstractEl.classList.contains('expanded')) {
                abstractEl.classList.remove('expanded');
                btnEl.textContent = 'View Abstract';
            } else {
                document.querySelectorAll('.abstract-content').forEach(el => {
                    el.classList.remove('expanded');
                });
                document.querySelectorAll('[id^="abstractBtn"]').forEach(btn => {
                    btn.textContent = 'View Abstract';
                });

                abstractEl.classList.add('expanded');
                btnEl.textContent = 'Hide Abstract';
            }
        }

        // Render proposal with comprehensive academic format
        function renderProposal(proposal) {
            // Title and metadata
            document.getElementById('proposalTitle').textContent = proposal.title || 'Research Proposal';
            document.getElementById('proposalDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Generate abstract from introduction (first 200 words)
            const intro = proposal.introduction || '';
            const abstractText = intro.split(' ').slice(0, 200).join(' ') + (intro.split(' ').length > 200 ? '...' : '');
            document.getElementById('proposalAbstract').textContent = abstractText;

            // Generate keywords from topic
            const topic = currentAnalysisData?.topic || 'research';
            const keywords = topic.split(' ')
                .filter(w => w.length > 3)
                .slice(0, 5)
                .join(', ') + ', methodology, analysis';
            document.getElementById('proposalKeywords').textContent = keywords;

            // Introduction sections
            const introText = proposal.introduction || '';
            const introParts = introText.split('. ');
            const partSize = Math.ceil(introParts.length / 4);

            document.getElementById('proposalBackground').textContent =
                introParts.slice(0, partSize).join('. ') + '.';
            document.getElementById('proposalProblem').textContent =
                introParts.slice(partSize, partSize * 2).join('. ') + '.';
            document.getElementById('proposalSignificance').textContent =
                introParts.slice(partSize * 2, partSize * 3).join('. ') + '.';
            document.getElementById('proposalGap').textContent =
                introParts.slice(partSize * 3).join('. ') || 'This research addresses critical gaps identified in the current literature.';

            // Literature Review sections
            const litReview = proposal.literature_review || '';
            const litParts = litReview.split('. ');
            const litPartSize = Math.ceil(litParts.length / 3);

            document.getElementById('proposalLitSummary').textContent =
                litParts.slice(0, litPartSize).join('. ') + '.';
            document.getElementById('proposalLitGaps').textContent =
                litParts.slice(litPartSize, litPartSize * 2).join('. ') + '.';
            document.getElementById('proposalTheoretical').textContent =
                litParts.slice(litPartSize * 2).join('. ') || 'The theoretical framework draws upon established models in the field.';

            // Research Questions
            const questionsEl = document.getElementById('proposalQuestions');
            const questions = proposal.research_questions || [];
            questionsEl.innerHTML = questions.map(q => `<li>${escapeHtml(q)}</li>`).join('');

            // Research Objectives (derived from questions)
            const objectivesEl = document.getElementById('proposalObjectives');
            objectivesEl.innerHTML = questions.map((q, i) => {
                const objective = q.replace(/\?$/, '').replace(/^(What|How|Why|When|Where|Which|Can|Does|Do|Is|Are)\s+/i, 'To investigate ');
                return `<li>${escapeHtml(objective)}</li>`;
            }).join('');

            // Methodology sections
            const methodology = proposal.methodology || '';
            const methParts = methodology.split('. ');
            const methPartSize = Math.ceil(methParts.length / 5);

            document.getElementById('proposalDesign').textContent =
                methParts.slice(0, methPartSize).join('. ') + '.';
            document.getElementById('proposalDataCollection').textContent =
                methParts.slice(methPartSize, methPartSize * 2).join('. ') + '.';
            document.getElementById('proposalSample').textContent =
                methParts.slice(methPartSize * 2, methPartSize * 3).join('. ') || 'Sample selection will follow purposive sampling techniques appropriate for the research design.';
            document.getElementById('proposalAnalysis').textContent =
                methParts.slice(methPartSize * 3, methPartSize * 4).join('. ') || 'Data analysis will employ both quantitative and qualitative methods as appropriate.';
            document.getElementById('proposalTools').textContent =
                methParts.slice(methPartSize * 4).join('. ') || 'Research tools will include statistical software, data collection instruments, and analysis frameworks.';

            // Expected Outcomes sections
            const outcomes = proposal.expected_outcomes || '';
            const outParts = outcomes.split('. ');
            const outPartSize = Math.ceil(outParts.length / 3);

            document.getElementById('proposalResults').textContent =
                outParts.slice(0, outPartSize).join('. ') + '.';
            document.getElementById('proposalContribution').textContent =
                outParts.slice(outPartSize, outPartSize * 2).join('. ') + '.';
            document.getElementById('proposalApplications').textContent =
                outParts.slice(outPartSize * 2).join('. ') || 'The findings will have practical applications in both academic and industry settings.';

            // Timeline table
            const timelineBody = document.getElementById('proposalTimelineBody');
            const timelineData = [
                { phase: 'Phase 1', activities: 'Literature Review & Research Design', duration: 'Months 1-2' },
                { phase: 'Phase 2', activities: 'Data Collection & Instrument Development', duration: 'Months 3-5' },
                { phase: 'Phase 3', activities: 'Data Analysis & Interpretation', duration: 'Months 6-8' },
                { phase: 'Phase 4', activities: 'Writing & Revision', duration: 'Months 9-10' },
                { phase: 'Phase 5', activities: 'Final Review & Submission', duration: 'Months 11-12' }
            ];
            timelineBody.innerHTML = timelineData.map(row =>
                `<tr><td>${row.phase}</td><td>${row.activities}</td><td>${row.duration}</td></tr>`
            ).join('');

            // Budget table
            const budgetBody = document.getElementById('proposalBudgetBody');
            const budgetData = [
                { item: 'Equipment', description: 'Computing resources and software licenses', cost: '$2,500' },
                { item: 'Data Collection', description: 'Survey tools, participant compensation', cost: '$1,500' },
                { item: 'Travel', description: 'Conference presentations and fieldwork', cost: '$3,000' },
                { item: 'Publication', description: 'Open access fees and formatting', cost: '$2,000' },
                { item: 'Miscellaneous', description: 'Printing, supplies, contingency', cost: '$1,000' }
            ];
            budgetBody.innerHTML = budgetData.map(row =>
                `<tr><td>${row.item}</td><td>${row.description}</td><td>${row.cost}</td></tr>`
            ).join('');
            document.getElementById('proposalTotalBudget').textContent = '$10,000';

            // References (APA format)
            const referencesEl = document.getElementById('proposalReferences');
            if (currentAnalysisData?.references) {
                const refs = currentAnalysisData.references.slice(0, 10);
                referencesEl.innerHTML = refs.map(ref =>
                    `<p class="reference-item">${escapeHtml(ref.reference)}</p>`
                ).join('');
            } else {
                referencesEl.innerHTML = `
                    <p class="reference-item">Doe, J., & Smith, A. (2024). Advances in research methodology. <em>Journal of Academic Research, 15</em>(3), 45-67. https://doi.org/10.1000/example</p>
                    <p class="reference-item">Johnson, M. (2023). Theoretical frameworks in modern research. <em>Research Quarterly, 28</em>(2), 112-128.</p>
                    <p class="reference-item">Williams, K., Brown, L., & Davis, R. (2023). Data analysis techniques for the digital age. <em>Computational Methods Journal, 7</em>(4), 234-256.</p>
                `;
            }
        }

        // Render trend chart
        function renderChart(chartData) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.years,
                    datasets: [{
                        label: 'Average Citations',
                        data: chartData.citations,
                        borderColor: '#141413',
                        backgroundColor: 'rgba(20, 20, 19, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#141413',
                        pointBorderColor: '#F0EEE6',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#141413',
                            titleFont: { size: 11, weight: '600' },
                            bodyFont: { size: 10 },
                            padding: 8,
                            cornerRadius: 4,
                            callbacks: {
                                label: function(context) {
                                    return `Avg: ${context.raw.toFixed(1)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(20, 20, 19, 0.05)' },
                            ticks: { font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // Format trend direction
        function formatTrend(trend) {
            const formats = {
                'heating_up': 'Rising',
                'stable': 'Stable',
                'cooling_down': 'Declining'
            };
            return formats[trend] || trend;
        }

        // Get trend color class
        function getTrendColor(trend) {
            const colors = {
                'heating_up': 'text-green-600',
                'stable': 'text-yellow-600',
                'cooling_down': 'text-red-600'
            };
            return colors[trend] || 'text-dark';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Download proposal as PDF
        function downloadAsPDF() {
            const proposalContent = document.querySelector('.academic-paper');
            const printWindow = window.open('', '_blank');
            const topic = currentAnalysisData?.topic || 'Download';

            const styles = `
                body {
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12pt;
                    line-height: 2;
                    color: #000;
                    background: white;
                    padding: 1in;
                    margin: 0;
                }
                .title-page {
                    text-align: center;
                    padding: 2in 0;
                    page-break-after: always;
                }
                .title-page h1 {
                    font-size: 18pt;
                    font-weight: bold;
                    margin-bottom: 2rem;
                    text-transform: uppercase;
                }
                .title-page .author { font-size: 12pt; margin: 0.5rem 0; }
                .title-page .affiliation { font-size: 11pt; font-style: italic; margin: 0.5rem 0; }
                .title-page .date { font-size: 12pt; margin-top: 2rem; }
                .abstract-section { margin: 2rem 0; }
                .abstract-section h2 { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 1rem; }
                .abstract-section p { text-align: justify; text-indent: 0; font-size: 11pt; line-height: 1.5; }
                .keywords { margin-top: 1rem; font-size: 11pt; }
                h2 { font-size: 14pt; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; }
                h3 { font-size: 12pt; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
                p { text-align: justify; text-indent: 0.5in; margin-bottom: 0; }
                p.no-indent { text-indent: 0; }
                ul, ol { margin-left: 0.5in; margin-top: 0.5rem; margin-bottom: 0.5rem; }
                li { margin-bottom: 0.25rem; }
                table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 11pt; }
                th, td { border: 1px solid #000; padding: 0.5rem; text-align: left; }
                th { font-weight: bold; background: #f5f5f5; }
                .reference-item { text-indent: -0.5in; padding-left: 0.5in; margin-bottom: 0.5rem; line-height: 1.5; }
                .page-number { text-align: center; font-size: 10pt; margin-top: 1rem; color: #666; }

                /* Page breaks */
                .title-page { page-break-after: always; }
                .abstract-section { page-break-after: always; }
                .references-section { page-break-before: always; }
                .section-literature-review { page-break-after: always; }
                table { page-break-inside: avoid; }
                h2, h3 { page-break-after: avoid; }
                p { orphans: 3; widows: 3; }
                .page-number { display: none; }

                /* Page numbering */
                @page {
                    margin: 1in;
                    @bottom-center {
                        content: "— " counter(page) " —";
                        font-family: 'Times New Roman', Times, serif;
                        font-size: 10pt;
                    }
                }

                @media print {
                    body { padding: 0; }
                }
            `;

            printWindow.document.write('<!DOCTYPE html><html><head>');
            printWindow.document.write('<title>Research Proposal - ' + topic + '<\/title>');
            printWindow.document.write('<style>' + styles + '<\/style>');
            printWindow.document.write('<\/head><body>');
            printWindow.document.write(proposalContent.innerHTML);
            printWindow.document.write('<\/body><\/html>');

            printWindow.document.close();
            printWindow.focus();

            setTimeout(function() {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Download proposal as DOCX
        function downloadAsDOCX() {
            const proposalContent = document.querySelector('.academic-paper');
            const title = document.getElementById('proposalTitle').textContent;

            const styles = `
                body {
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12pt;
                    line-height: 2;
                }
                h1 { font-size: 18pt; font-weight: bold; text-align: center; text-transform: uppercase; }
                h2 { font-size: 14pt; font-weight: bold; margin-top: 24pt; }
                h3 { font-size: 12pt; font-weight: bold; margin-top: 12pt; }
                p { text-align: justify; text-indent: 36pt; margin: 0 0 12pt 0; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid black; padding: 6pt; }
                th { background-color: #f0f0f0; font-weight: bold; }
                .title-page { text-align: center; margin-bottom: 72pt; }
                .author, .affiliation, .date { text-align: center; margin: 6pt 0; }
            `;

            // Create HTML content for Word
            let htmlContent = '<!DOCTYPE html>';
            htmlContent += '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">';
            htmlContent += '<head><meta charset="utf-8">';
            htmlContent += '<title>' + title + '<\/title>';
            htmlContent += '<style>' + styles + '<\/style>';
            htmlContent += '<\/head><body>';
            htmlContent += proposalContent.innerHTML;
            htmlContent += '<\/body><\/html>';

            // Create blob and download
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword'
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Research_Proposal_' + (currentAnalysisData?.topic || 'document').replace(/\s+/g, '_') + '.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
